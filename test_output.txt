Loading data...
Data loaded: 4108 rows from 2010-01-01 to 2025-09-30

============================================================
Test 1: AFNS Model
============================================================

=== Fitting AFNS VAR(1) + Kalman Filter ===
Initializing factors using DNS approximation...
Setting initial parameter guesses...
Running maximum likelihood optimization via BFGS...
  Optimizing 15 parameters (A, b, Q)
  This may take 20-30 seconds...
  BFGS iterations:   0%|          | 0/100 [00:00<?, ?iter/s]  BFGS iterations:   1%|          | 1/100 [00:04<07:04,  4.29s/iter]  BFGS iterations:   2%|▏         | 2/100 [00:10<09:19,  5.71s/iter]  BFGS iterations:   3%|▎         | 3/100 [00:28<17:40, 10.93s/iter]  BFGS iterations:   4%|▍         | 4/100 [00:33<14:03,  8.78s/iter]  BFGS iterations:   5%|▌         | 5/100 [00:35<09:56,  6.27s/iter]  BFGS iterations:   6%|▌         | 6/100 [00:37<07:29,  4.78s/iter]  BFGS iterations:   7%|▋         | 7/100 [00:39<05:55,  3.82s/iter]  BFGS iterations:   8%|▊         | 8/100 [00:44<06:34,  4.29s/iter]  BFGS iterations:   9%|▉         | 9/100 [00:46<05:22,  3.54s/iter]  BFGS iterations:  10%|█         | 10/100 [00:48<04:35,  3.06s/iter]  BFGS iterations:  11%|█         | 11/100 [00:52<04:51,  3.28s/iter]  BFGS iterations:  12%|█▏        | 12/100 [00:54<04:12,  2.87s/iter]  BFGS iterations:  13%|█▎        | 13/100 [00:59<05:27,  3.76s/iter]  BFGS iterations:  14%|█▍        | 14/100 [01:01<04:33,  3.18s/iter]  BFGS iterations:  15%|█▌        | 15/100 [01:03<03:56,  2.78s/iter]  BFGS iterations:  16%|█▌        | 16/100 [01:09<05:13,  3.73s/iter]  BFGS iterations:  17%|█▋        | 17/100 [01:44<18:07, 13.10s/iter]  BFGS iterations:  18%|█▊        | 18/100 [01:46<13:20,  9.77s/iter]  BFGS iterations:  19%|█▉        | 19/100 [01:55<13:00,  9.63s/iter]  BFGS iterations:  20%|██        | 20/100 [01:57<09:46,  7.33s/iter]  BFGS iterations:  21%|██        | 21/100 [02:06<10:18,  7.83s/iter]  BFGS iterations:  22%|██▏       | 22/100 [02:08<07:45,  5.97s/iter]  BFGS iterations:  23%|██▎       | 23/100 [02:13<07:21,  5.73s/iter]  BFGS iterations:  24%|██▍       | 24/100 [02:15<05:43,  4.52s/iter]  BFGS iterations:  25%|██▌       | 25/100 [02:18<05:22,  4.31s/iter]  BFGS iterations:  26%|██▌       | 26/100 [02:27<06:51,  5.56s/iter]  BFGS iterations:  27%|██▋       | 27/100 [02:29<05:20,  4.39s/iter]  BFGS iterations:  28%|██▊       | 28/100 [02:35<06:07,  5.10s/iter]                                                                     Model is not converging.  Current: 32035.05039725664 is not greater than 32035.39097354259. Delta is -0.34057628595110145

  ⚠ Warning: Desired error not necessarily achieved due to precision loss.
  This is often OK - optimizer stopped due to numerical precision limits
  Check RMSE below to verify fit quality
Running final Kalman filter...

Fitted VAR(1) Parameters:
  Transition matrix A:
[[ 0.05759182 -0.32531355 -0.19941712]
 [ 0.13316731  0.97492184  0.05182396]
 [ 0.87347661  0.30386818  1.18331822]]
  Drift vector b: [ 2.55934587 -0.48502173 -2.36073754]
  State covariance Q (diagonal): [0.00181654 1.5218019  0.02210574]

Log-likelihood: -42034.09
Overall RMSE: 0.2092 bps

RMSE by maturity:
  2yr: 0.2828 bps
  3yr: 0.1741 bps
  5yr: 0.0942 bps
  7yr: 0.1287 bps
  10yr: 0.1577 bps
  30yr: 0.3193 bps

✓ AFNS passed: RMSE = 0.21 bps
  ✓ RMSE < 10bp threshold (good fit)

============================================================
Test 2: Sticky HMM
============================================================

=== Fitting Sticky HMM ===
Testing K ∈ [2, 3, 4, 5] states...
  Fitting HMM with K=2 states...
    BIC: -59990.92, Avg regime duration: 414.1 days
  Fitting HMM with K=3 states...
    BIC: -59630.10, Avg regime duration: 79.8 days
  Fitting HMM with K=4 states...
    Failed to fit K=4: 'covars' must be symmetric, positive-definite
  Fitting HMM with K=5 states...
    BIC: -63254.13, Avg regime duration: 187.4 days

Selected K=5 states (lowest BIC)

Transition Matrix:
[[9.09090939e-01 9.07302333e-02 1.73390325e-04 5.43782196e-06
  0.00000000e+00]
 [7.28755607e-02 9.23502067e-01 1.66739837e-03 1.95497426e-03
  0.00000000e+00]
 [1.75488821e-07 3.54620397e-03 9.96164112e-01 2.89508146e-04
  0.00000000e+00]
 [2.72200425e-07 1.51537729e-03 7.13976275e-05 9.98412953e-01
  0.00000000e+00]
 [0.00000000e+00 0.00000000e+00 4.54545455e-02 0.00000000e+00
  9.54545455e-01]]

Regime Properties:
  Regime 0:
    Mean Δ[L,S,C]: [ 0.00249949 -0.0010566  -0.01006287]
    Self-transition prob: 0.909
    Expected duration: 11.0 days
  Regime 1:
    Mean Δ[L,S,C]: [ 0.00246951 -0.00028201 -0.0099048 ]
    Self-transition prob: 0.924
    Expected duration: 13.1 days
  Regime 2:
    Mean Δ[L,S,C]: [ 0.02353363 -0.03219326 -0.05479758]
    Self-transition prob: 0.996
    Expected duration: 260.7 days
  Regime 3:
    Mean Δ[L,S,C]: [-0.0108745   0.01344284  0.02751365]
    Self-transition prob: 0.998
    Expected duration: 630.1 days
  Regime 4:
    Mean Δ[L,S,C]: [ 0.5715318  -0.6015175  -0.56507642]
    Self-transition prob: 0.955
    Expected duration: 22.0 days

✓ HMM passed: 5 states detected
  Transition matrix diagonal: [0.90909094 0.92350207 0.99616411 0.99841295 0.95454545]
  ✓ All diagonal elements > 0.80 (sticky regimes)

============================================================
Test 3: Scenario Path Generation
============================================================

=== Generating 100 Scenario Paths ===
Horizon: 10 days
Fed shock: +0 bps
Parallel workers: 1
Simulating paths...
  Progress:   0%|          | 0/100 [00:00<?, ?it/s]  Progress: 100%|██████████| 100/100 [00:00<00:00, 1660.10it/s]
Combining paths...
Computing percentiles...
Simulation complete: 1100 total rows
  Paths: 100
  Time steps per path: 11

✓ Paths generated: 1100 rows (100 paths × 11 steps)
  Percentiles computed for 6 tenors

  Sample: 10yr yield at horizon
    Current: 4.14%
    p5:  0.48%
    p50: 3.89%
    p95: 6.78%

============================================================
VALIDATION SUMMARY
============================================================
✓ Test 1: AFNS fit successful (RMSE = 0.21bp)
✓ Test 2: HMM fit successful (5 states, min diag = 0.909)
✓ Test 3: Paths generated successfully

============================================================
CHECKLIST:
============================================================
  ✓ RMSE < 10bp? 0.21bp
  ✓ Transition matrix diagonal > 0.80? 0.909
  ✓ Paths generated? Yes

============================================================
✓ ALL CHECKS PASSED - Implementation likely correct!

Next step: Run 'python main.py' to check coverage > 80%
============================================================
